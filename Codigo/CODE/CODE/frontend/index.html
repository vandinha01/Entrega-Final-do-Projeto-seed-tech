<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Seed Tech - CRUD Armazéns</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:24px;color:#222}
    h1{font-size:26px}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    input[type=text], input[type=number]{padding:6px;border:1px solid #ccc;border-radius:4px}
    button{padding:8px 12px;border:none;border-radius:4px;background:#2f855a;color:#fff;cursor:pointer}
    button.danger{background:#c53030}
    button.secondary{background:#4a5568}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:10px;border:1px solid #eee;text-align:left}
    th{background:#222;color:#fff}
    .small{font-size:13px;color:#666}
    #msg{margin-top:12px}
  </style>
</head>
<body>
  <h1>Dashboard de Armazéns</h1>

  <div>
    <form id="form">
      <div class="row">
        <input id="nome" placeholder="Nome do Armazém" required style="flex:2" />
        <input id="localizacao" placeholder="Localização" style="flex:2" />
        <input id="capacidadeKg" type="number" placeholder="Capacidade (kg)" style="width:160px" />
        <button id="submitBtn">Adicionar</button>
        <button id="cancelEdit" type="button" style="display:none;margin-left:6px" class="secondary">Cancelar</button>
      </div>
    </form>
    <div id="msg" class="small"></div>
  </div>

  <table id="table">
    <thead>
      <tr><th>ID</th><th>Nome</th><th>Localização</th><th>Capacidade (kg)</th><th>Ações</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const base = 'http://localhost:8080/armazens';
    const tbody = document.querySelector('#table tbody');
    const form = document.getElementById('form');
    const nomeEl = document.getElementById('nome');
    const locEl = document.getElementById('localizacao');
    const capEl = document.getElementById('capacidadeKg');
    const submitBtn = document.getElementById('submitBtn');
    const cancelEdit = document.getElementById('cancelEdit');
    const msg = document.getElementById('msg');

    let editId = null;

    function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    async function showMsg(t, ok=true){
      msg.textContent = t;
      msg.style.color = ok ? '#2f855a' : '#c53030';
      setTimeout(()=> msg.textContent = '', 4000);
    }

    async function fetchList(){
      try{
        const res = await fetch(base);
        if(!res.ok) throw new Error('Erro ao buscar lista');
        const json = await res.json();
        renderTable(json);
      }catch(e){
        renderTable([]);
        showMsg('Erro conectando ao backend. Verifique se o backend está rodando.', false);
      }
    }

    function renderTable(list){
      tbody.innerHTML = '';
      if(!list || list.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" class="small">Nenhum registro.</td></tr>';
        return;
      }
      list.forEach(row=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.id ?? ''}</td>
          <td>${escapeHtml(row.nome ?? '')}</td>
          <td>${escapeHtml(row.localizacao ?? '')}</td>
          <td>${row.capacidadeKg ?? ''}</td>
          <td>
            <button class="edit" data-id="${row.id}">Editar</button>
            <button class="delete" data-id="${row.id}" style="margin-left:6px" class="danger">Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      Array.from(tbody.querySelectorAll('button.edit')).forEach(b=>{
        b.addEventListener('click', onEdit);
      });
      Array.from(tbody.querySelectorAll('button.delete')).forEach(b=>{
        b.addEventListener('click', onDelete);
      });
    }

    async function onEdit(e){
      const id = e.currentTarget.dataset.id;
      try{
        const res = await fetch(`${base}/${id}`);
        if(!res.ok) throw new Error('Não encontrado');
        const data = await res.json();
        editId = data.id;
        nomeEl.value = data.nome || '';
        locEl.value = data.localizacao || '';
        capEl.value = data.capacidadeKg ?? '';
        submitBtn.textContent = 'Salvar';
        cancelEdit.style.display = 'inline-block';
        showMsg('Modo edição ativado (clique em Cancelar para voltar).');
      }catch(err){
        showMsg('Erro ao carregar item para edição', false);
      }
    }

    async function onDelete(e){
      const id = e.currentTarget.dataset.id;
      if(!confirm('Confirma exclusão?')) return;
      try{
        const res = await fetch(`${base}/${id}`, { method: 'DELETE' });
        if(res.status === 204){
          showMsg('Excluído com sucesso');
          fetchList();
        } else {
          const j = await res.json().catch(()=>null);
          showMsg('Erro ao excluir: ' + (j?.message || res.status), false);
        }
      }catch(err){
        showMsg('Erro ao conectar ao backend', false);
      }
    }

    cancelEdit.addEventListener('click', ()=>{
      editId = null;
      nomeEl.value = locEl.value = capEl.value = '';
      submitBtn.textContent = 'Adicionar';
      cancelEdit.style.display = 'none';
    });

    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const body = {
        nome: nomeEl.value.trim(),
        localizacao: locEl.value.trim(),
        capacidadeKg: capEl.value ? Number(capEl.value) : null
      };
      try{
        let res;
        if(editId){
          res = await fetch(`${base}/${editId}`, {
            method: 'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });
        } else {
          res = await fetch(base, {
            method: 'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });
        }
        if(res.ok){
          const json = await res.json();
          showMsg(editId ? 'Atualizado' : 'Criado');
          editId = null;
          submitBtn.textContent = 'Adicionar';
          cancelEdit.style.display = 'none';
          nomeEl.value = locEl.value = capEl.value = '';
          fetchList();
        } else {
          const j = await res.json().catch(()=>null);
          showMsg('Erro: ' + (j?.message || res.status), false);
        }
      }catch(err){
        showMsg('Erro ao conectar ao backend', false);
      }
    });

    // inicializa
    fetchList();
  </script>
</body>
</html>
